const News = require('../models/News')

class NewsController {
    async getAll(req, res) {
        try {
          const news = await News.find().sort({ _id: -1 })
          
          res.json({
            success: true,
            newsWithFullImagePaths: news // ← Просто возвращаем как есть
          })
        } catch (error) {
          console.error('Error fetching news:', error)
          res.status(500).json({ 
            success: false,
            error: 'Ошибка при получении новостей' 
          })
        }
      }
      
      async getById(req, res) {
        try {
          const { id } = req.params
          const newsItem = await News.findById(id)
      
          if (!newsItem) {
            return res.status(404).json({ 
              success: false,
              error: 'Новость не найдена' 
            })
          }
      
          // Добавляем полный путь к изображению
          const itemObj = newsItem.toObject()
          itemObj.image = `${req.protocol}://${req.get('host')}/uploads/${itemObj.image}`
      
          res.json({
            success: true,
             itemObj
          })
        } catch (error) {
          console.error('Error fetching news by ID:', error)
          res.status(500).json({ 
            success: false,
            error: 'Ошибка при получении новости' 
          })
        }
      }
  async getById(req, res) {
    try {
      const { id } = req.params

      const newsItem = await News.findById(id)

      if (!newsItem) {
        return res.status(404).json({ 
          success: false,
          error: 'Новость не найдена' 
        })
      }


      res.json({
        success: true,
        data: newsItem
      })
    } catch (error) {
      console.error('Error fetching news by ID:', error)
      res.status(500).json({ 
        success: false,
        error: 'Ошибка при получении новости' 
      })
    }
  }


  async create(req, res) {
    try {
      const { title, description, content, date, image } = req.body

      if (!title || !description || !content || !date) {
        return res.status(400).json({ 
          success: false,
          error: 'Все поля обязательны' 
        })
      }

      const newsItem = await News.create({
        title,
        description,
        content,
        date,
        image: image || '/img/img1.png'
      })

      res.status(201).json({
        success: true,
        data: newsItem
      })
    } catch (error) {
      console.error('Error creating news:', error)
      
      // Обработка ошибок валидации
      if (error.name === 'ValidationError') {
        const messages = Object.values(error.errors).map(err => err.message)
        return res.status(400).json({ 
          success: false,
          error: messages.join(', ') 
        })
      }

      res.status(500).json({ 
        success: false,
        error: 'Ошибка при создании новости' 
      })
    }
  }


  async update(req, res) {
    try {
      const { id } = req.params
      const { title, description, content, date, image } = req.body

      const newsItem = await News.findByIdAndUpdate(
        id,
        { title, description, content, date, image },
        { new: true, runValidators: true } 
      )

      if (!newsItem) {
        return res.status(404).json({ 
          success: false,
          error: 'Новость не найдена' 
        })
      }

      res.json({
        success: true,
        data: newsItem
      })
    } catch (error) {
      console.error('Error updating news:', error)
      
      if (error.name === 'ValidationError') {
        const messages = Object.values(error.errors).map(err => err.message)
        return res.status(400).json({ 
          success: false,
          error: messages.join(', ') 
        })
      }

      res.status(500).json({ 
        success: false,
        error: 'Ошибка при обновлении новости' 
      })
    }
  }

  async delete(req, res) {
    try {
      const { id } = req.params

      const newsItem = await News.findByIdAndDelete(id)

      if (!newsItem) {
        return res.status(404).json({ 
          success: false,
          error: 'Новость не найдена' 
        })
      }

      res.json({
        success: true,
        message: 'Новость удалена',
        data: newsItem
      })
    } catch (error) {
      console.error('Error deleting news:', error)
      res.status(500).json({ 
        success: false,
        error: 'Ошибка при удалении новости' 
      })
    }
  }

  async seed(req, res) {
    try {
      await News.deleteMany({})

      // Тестовые данные
      const initialNews = [
        {
            id: 1,
            title: 'ЗАГОЛОВОК НОВОСТИ 1',
            description: 'Описание новости в 3 строки Описание новости в 3 строки Описание новости в 3 строки Описание новости в 3 строки Описание новости в 3 строки Описание...',
            date: '01 января 1990',
            image: '/img/items/img1.png',
            h3: `Студия графического и веб-дизайна “500 на 700” объявила о запуске нового сервиса - создании уникальных логотипов для бизнеса. `,
            content: [
              "В студии уверены, что их подход к дизайну и внимание к деталям помогут создать логотип, который станет визитной карточкой любой компании.",
              "Студия уже имеет опыт работы с крупными клиентами из различных отраслей, и теперь предлагает свои услуги малым и средним предприятиям. “Мы стремимся к тому, чтобы каждый клиент получил именно то, что ему нужно, и в то же время оставался доволен результатом”, - говорит руководитель студии “500 на 700”.",
              `Новый сервис уже доступен на сайте студии, и клиенты могут заказать разработку логотипа как для своего бизнеса, так и для социальных сетей. “Создание логотипа - это важный шаг для любого бизнеса, и мы рады помочь в этом процессе”, - добавляет руководитель студии.`
            ]
            },
          {
            id: 2,
            title: 'ЗАГОЛОВОК НОВОСТИ 2',
            description: 'Описание новости в 3 строки Описание новости в 3 строки Описание новости в 3 строки Описание новости в 3 строки Описание новости в 3 строки Описание...',
            date: '01 января 1990',
            image: '/img/items/img2.png',
            h3: `Студия графического и веб-дизайна “500 на 700” объявила о запуске нового сервиса - создании уникальных логотипов для бизнеса. `,
            content: [
              "В студии уверены, что их подход к дизайну и внимание к деталям помогут создать логотип, который станет визитной карточкой любой компании.",
              "Студия уже имеет опыт работы с крупными клиентами из различных отраслей, и теперь предлагает свои услуги малым и средним предприятиям. “Мы стремимся к тому, чтобы каждый клиент получил именно то, что ему нужно, и в то же время оставался доволен результатом”, - говорит руководитель студии “500 на 700”.",
              `Новый сервис уже доступен на сайте студии, и клиенты могут заказать разработку логотипа как для своего бизнеса, так и для социальных сетей. “Создание логотипа - это важный шаг для любого бизнеса, и мы рады помочь в этом процессе”, - добавляет руководитель студии.`
            ]
          },
          {
            id: 3,
            title: 'ЗАГОЛОВОК НОВОСТИ 3',
            description: 'Описание новости в 3 строки Описание новости в 3 строки Описание новости в 3 строки Описание новости в 3 строки Описание новости в 3 строки Описание...',
            date: '01 января 1990',
            image: '/img/items/img3.png',
            h3: `Студия графического и веб-дизайна “500 на 700” объявила о запуске нового сервиса - создании уникальных логотипов для бизнеса. `,
            content: [
              "В студии уверены, что их подход к дизайну и внимание к деталям помогут создать логотип, который станет визитной карточкой любой компании.",
              "Студия уже имеет опыт работы с крупными клиентами из различных отраслей, и теперь предлагает свои услуги малым и средним предприятиям. “Мы стремимся к тому, чтобы каждый клиент получил именно то, что ему нужно, и в то же время оставался доволен результатом”, - говорит руководитель студии “500 на 700”.",
              `Новый сервис уже доступен на сайте студии, и клиенты могут заказать разработку логотипа как для своего бизнеса, так и для социальных сетей. “Создание логотипа - это важный шаг для любого бизнеса, и мы рады помочь в этом процессе”, - добавляет руководитель студии.`
            ]
          },
          {
            id: 4,
            title: 'ЗАГОЛОВОК НОВОСТИ 4',
            description: 'Описание новости в 3 строки Описание новости в 3 строки Описание новости в 3 строки Описание новости в 3 строки Описание новости в 3 строки Описание...',
            date: '01 января 1990',
            image: '/img/items/img4.png',
            h3: `Студия графического и веб-дизайна “500 на 700” объявила о запуске нового сервиса - создании уникальных логотипов для бизнеса. `,
            content: [
              "В студии уверены, что их подход к дизайну и внимание к деталям помогут создать логотип, который станет визитной карточкой любой компании.",
              "Студия уже имеет опыт работы с крупными клиентами из различных отраслей, и теперь предлагает свои услуги малым и средним предприятиям. “Мы стремимся к тому, чтобы каждый клиент получил именно то, что ему нужно, и в то же время оставался доволен результатом”, - говорит руководитель студии “500 на 700”.",
              `Новый сервис уже доступен на сайте студии, и клиенты могут заказать разработку логотипа как для своего бизнеса, так и для социальных сетей. “Создание логотипа - это важный шаг для любого бизнеса, и мы рады помочь в этом процессе”, - добавляет руководитель студии.`
            ]
          },
          {
            id: 5,
            title: 'ЗАГОЛОВОК НОВОСТИ 5',
            description: 'Описание новости в 3 строки Описание новости в 3 строки Описание новости в 3 строки Описание новости в 3 строки Описание новости в 3 строки Описание...',
            date: '01 января 1990',
            image: '/img/items/img5.png',
            h3: `Студия графического и веб-дизайна “500 на 700” объявила о запуске нового сервиса - создании уникальных логотипов для бизнеса. `,
            content: [
              "В студии уверены, что их подход к дизайну и внимание к деталям помогут создать логотип, который станет визитной карточкой любой компании.",
              "Студия уже имеет опыт работы с крупными клиентами из различных отраслей, и теперь предлагает свои услуги малым и средним предприятиям. “Мы стремимся к тому, чтобы каждый клиент получил именно то, что ему нужно, и в то же время оставался доволен результатом”, - говорит руководитель студии “500 на 700”.",
              `Новый сервис уже доступен на сайте студии, и клиенты могут заказать разработку логотипа как для своего бизнеса, так и для социальных сетей. “Создание логотипа - это важный шаг для любого бизнеса, и мы рады помочь в этом процессе”, - добавляет руководитель студии.`
            ]
          },
          {
            id: 6,
            title: 'ЗАГОЛОВОК НОВОСТИ 6',
            description: 'Описание новости в 3 строки Описание новости в 3 строки Описание новости в 3 строки Описание новости в 3 строки Описание новости в 3 строки Описание...',
            date: '01 января 1990',
            image: '/img/items/img6.png',
            h3: `Студия графического и веб-дизайна “500 на 700” объявила о запуске нового сервиса - создании уникальных логотипов для бизнеса. `,
            content: [
              "В студии уверены, что их подход к дизайну и внимание к деталям помогут создать логотип, который станет визитной карточкой любой компании.",
              "Студия уже имеет опыт работы с крупными клиентами из различных отраслей, и теперь предлагает свои услуги малым и средним предприятиям. “Мы стремимся к тому, чтобы каждый клиент получил именно то, что ему нужно, и в то же время оставался доволен результатом”, - говорит руководитель студии “500 на 700”.",
              `Новый сервис уже доступен на сайте студии, и клиенты могут заказать разработку логотипа как для своего бизнеса, так и для социальных сетей. “Создание логотипа - это важный шаг для любого бизнеса, и мы рады помочь в этом процессе”, - добавляет руководитель студии.`
            ]
          }
      ]

      const created = await News.insertMany(initialNews)

      res.json({
        success: true,
        message: 'Database seeded successfully',
        count: created.length,
        data: created
      })
    } catch (error) {
      console.error('Error seeding database:', error)
      res.status(500).json({ 
        success: false,
        error: 'Ошибка при заполнении базы данных' 
      })
    }
  }
}

module.exports = new NewsController()